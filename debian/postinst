#!/bin/bash

# postinst
#
# Copyright (C) 2014 Kano Computing Ltd.
# License: http://www.gnu.org/licenses/gpl-2.0.txt GNU General Public License v2
#

lightdm_greeter_config=/etc/lightdm/lightdm-gtk-greeter.conf
custom_lightdm_greeter_config=/usr/share/kano-desktop/lightdm/lightdm-gtk-greeter.conf

lightdm_config=/etc/lightdm/lightdm.conf

chromium_master_prefs=/etc/chromium/master_preferences
custom_chromium_master_prefs=/usr/share/kano-desktop/config/chromium/master_preferences

chromium_bookmarks=/etc/chromium/initial_bookmarks.html
custom_chromium_bookmarks=/usr/share/kano-desktop/config/chromium/initial_bookmarks.html

LXDE_AUTOSTART=/etc/xdg/lxsession/LXDE/autostart

# This is to get squeak working on the system out of the box. Can be removed if short of space on SD.
SQUEAKURL=http://dev.kano.me/public/squeak.tar.gz
SQUEAKTAR=squeak.tar.gz
SQUEAKDIR=/usr/share/squeak
mkdir -p $SQUEAKDIR
wget -nv $SQUEAKURL
tar -zxvf $SQUEAKTAR
mv squeak/* $SQUEAKDIR
ln -s /usr/share/squeak /etc/skel/
rm -r squeak
rm $SQUEAKTAR

TMP_WOLFRAM_FILE=/tmp/wolfram-installer_conf
TMP_LIBREOFFICE_FILE=/tmp/libreoffice-installer_conf

case "$1" in
    configure)

        # Make links in /etc/skel
        ln -s /usr/share/kano-desktop/config/openbox /etc/skel/.config/openbox
        ln -s /usr/share/kano-desktop/config/pcmanfm /etc/skel/.config/pcmanfm
        ln -s /usr/share/kano-desktop/config/lxpanel /etc/skel/.config/lxpanel
        ln -s /usr/share/kano-desktop/kdesk/.kdeskrc /etc/skel/.kdeskrc

        # Configure lightdm
        cp $lightdm_greeter_config $lightdm_greeter_config-old
        cat $custom_lightdm_greeter_config > $lightdm_greeter_config

        # Display a list of user names when logging in
        sed -i 's/#\?\s*\(greeter-hide-users\=\).*/\1false/' "$lightdm_config"
        sed -i 's/^\s*\(user-session\=\).*/# \1default/' "$lightdm_config"

        # Configure chromium
        cp $chromium_master_prefs $chromium_master_prefs-old
        cat $custom_chromium_master_prefs >$chromium_master_prefs

        cp $chromium_bookmarks $chromium_bookmarks-old
        cat $custom_chromium_bookmarks >$chromium_bookmarks

        # Set kdesk as the desktop manager
        sudo sed -i 's/\@pcmanfm --desktop --profile LXDE/\@kdesk/g' $LXDE_AUTOSTART

        # And remove the defaut screen saver, as we provide our own
        sudo sed -i 's/\@xscreensaver -no-splash//g' $LXDE_AUTOSTART

        # Update kanux installed fonts information for the X server
        mkfontdir /usr/share/fonts/kanux
        mkfontscale /usr/share/fonts/kanux
        fc-cache

        # Copy volume control images to nuoveXT2 theme
        # TODO: this won't be needed when we have our own icon theme
        cp -f /usr/share/kano-desktop/images/audio-volume-* /usr/share/icons/nuoveXT2/48x48/status
        mv -f /usr/share/icons/nuoveXT2/icon-theme.cache /usr/share/icons/nuoveXT2/icon-theme.cache.bak 2> /dev/null

        # Create custom sudoers file for Wolfram
        echo "%sudo ALL=(root) NOPASSWD: /usr/bin/wolfram-installer" > $TMP_WOLFRAM_FILE
        # The owner and group for the sudoers file must both be 0
        chown root:root $TMP_WOLFRAM_FILE
        # The file permissions must be set to 0440
        chmod 0440 $TMP_WOLFRAM_FILE
        # Move the file to the sudoers directory
        mv $TMP_WOLFRAM_FILE /etc/sudoers.d/

        # Create custom sudoers file for LibreOffice
        echo "%sudo ALL=(root) NOPASSWD: /usr/bin/libreoffice-installer" > $TMP_LIBREOFFICE_FILE
        chown root:root $TMP_LIBREOFFICE_FILE
        chmod 0440 $TMP_LIBREOFFICE_FILE
        mv $TMP_LIBREOFFICE_FILE /etc/sudoers.d/

        ;;
esac

#DEBHELPER#

exit 0
